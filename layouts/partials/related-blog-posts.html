{{/* Partial: related-blog-posts.html
   Usage: {{ partial "related-blog-posts.html" (dict "keywords" "ransomware,backup" "count" 3 "page" .) }}
*/}}

{{- $baseURL := "https://guardianhubx.com" -}}
{{- $page := .page -}}
{{- $jsonPath := cond (eq $page.Lang "ca") "/blog/ca/index.json" "/blog/index.json" -}}
{{- $finalURL := printf "%s%s" $baseURL $jsonPath -}}

{{- if hugo.IsProduction -}}
  {{ $finalURL = printf "%s?t=%d" $finalURL now.Unix }}
{{- end -}}

{{- $res := try (resources.GetRemote $finalURL) -}}

{{- if and (not $res.Err) $res.Value -}}
  {{- $posts := $res.Value.Content | unmarshal -}}
  {{- $keywordString := .keywords | default "" -}}
  {{- $count := (.count | default "3") | int -}}
  {{- $matchedPosts := slice -}}

  {{- if $keywordString -}}
    {{- $keywords := $keywordString | strings.Split "," -}}

    {{- range $posts -}}
      {{- $post := . -}}
      {{- $matched := false -}}

      {{- range $keywords -}}
        {{- $keyword := strings.ToLower (strings.TrimSpace .) -}}
        {{- $titleMatch := in (strings.ToLower $post.title) $keyword -}}
        {{- $tagsStr := "" -}}
        {{- if $post.tags -}}
          {{- $tagsStr = delimit $post.tags ", " -}}
        {{- end -}}
        {{- $tagsMatch := false -}}
        {{- if gt (len $tagsStr) 0 -}}
          {{- $tagsMatch = in (strings.ToLower $tagsStr) $keyword -}}
        {{- end -}}
        {{- $categoriesStr := "" -}}
        {{- if $post.categories -}}
          {{- $categoriesStr = delimit $post.categories ", " -}}
        {{- end -}}
        {{- $categoriesMatch := false -}}
        {{- if gt (len $categoriesStr) 0 -}}
          {{- $categoriesMatch = in (strings.ToLower $categoriesStr) $keyword -}}
        {{- end -}}
        {{- if or $titleMatch $tagsMatch $categoriesMatch -}}
          {{- $matched = true -}}
        {{- end -}}
      {{- end -}}

      {{- if $matched -}}
        {{- $matchedPosts = $matchedPosts | append $post -}}
      {{- end -}}
    {{- end -}}

    {{- if gt (len $matchedPosts) 0 -}}
    <section class="related-posts-section bg-light py-4 px-3 rounded-3 border-start border-4 border-primary shadow-sm my-4">
      <h4 class="mb-3">
        <i class="fas fa-newspaper me-2 text-primary"></i>
        {{ cond (eq $page.Lang "es") "Artículos relacionados" (cond (eq $page.Lang "ca") "Articles relacionats" "Related Articles") }}
      </h4>
      <ul class="list-unstyled">
        {{- range first $count $matchedPosts -}}
        <li class="mb-2">
          <a href="{{ .permalink }}" class="text-decoration-none text-dark fw-500" title="{{ .title }}">
            <i class="fas fa-arrow-right me-2 text-primary" style="font-size: 0.8em;"></i>
            {{ .title }}
          </a>
          <div class="small text-muted mt-1">
            {{ .summary | plainify | truncate 120 }}
          </div>
        </li>
        {{- end -}}
      </ul>
      <div class="mt-3">
        <a href="{{ if eq $page.Lang "ca" }}/blog/ca/{{ else }}/blog/{{ end }}" class="btn btn-sm btn-outline-primary">
          {{ cond (eq $page.Lang "es") "Ver todos los artículos" (cond (eq $page.Lang "ca") "Veure tots els articles" "View all articles") }} →
        </a>
      </div>
    </section>
    {{- end -}}
  {{- end -}}
{{- end -}}
