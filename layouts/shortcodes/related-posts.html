{{/* layouts/shortcodes/related-posts.html
   Usage: {{< related-posts keywords="ransomware,endpoint security,backup" count="3" >}}
*/}}

{{- $baseURL := "https://guardianhubx.com" -}}
{{- $jsonPath := cond (eq .Site.Language.Lang "ca") "/blog/ca/index.json" "/blog/index.json" -}}
{{- $finalURL := printf "%s%s" $baseURL $jsonPath -}}

{{- if hugo.IsProduction -}}
  {{ $finalURL = printf "%s?t=%d" $finalURL now.Unix }}
{{- end -}}

{{- $res := try (resources.GetRemote $finalURL) }}

{{ if and (not $res.Err) $res.Value }}
  {{ $posts := $res.Value.Content | unmarshal }}
  {{ $keywords := (.Get "keywords") | strings.Split "," }}
  {{ $count := (.Get "count" | default "3") | int }}
  {{ $matchedPosts := slice }}

  {{/* Filter posts by keywords */}}
  {{ range $posts }}
    {{ $post := . }}
    {{ $matched := false }}

    {{/* Check if any keyword matches tags, title, or content */}}
    {{ range $keywords }}
      {{ $keyword := strings.ToLower (strings.TrimSpace .) }}
      {{ if or
          (in (strings.ToLower $post.title) $keyword)
          (in (strings.ToLower (delimit $post.tags ", ")) $keyword)
          (in (strings.ToLower (delimit $post.categories ", ")) $keyword)
      }}
        {{ $matched = true }}
      {{ end }}
    {{ end }}

    {{ if $matched }}
      {{ $matchedPosts = $matchedPosts | append $post }}
    {{ end }}
  {{ end }}

  {{/* Display matched posts */}}
  {{ if gt (len $matchedPosts) 0 }}
  <section class="related-posts-section bg-light py-4 px-3 rounded-3 border-start border-4 border-primary shadow-sm my-4">
    <h4 class="mb-3">
      <i class="fas fa-newspaper me-2 text-primary"></i>
      {{ cond (eq .Page.Lang "es") "Artículos relacionados" (cond (eq .Page.Lang "ca") "Articles relacionats" "Related Articles") }}
    </h4>
    <ul class="list-unstyled">
      {{ range first $count $matchedPosts }}
      <li class="mb-2">
        <a href="{{ .permalink }}" class="text-decoration-none text-dark fw-500 hover-underline" title="{{ .title }}">
          <i class="fas fa-arrow-right me-2 text-primary" style="font-size: 0.8em;"></i>
          {{ .title }}
        </a>
        <div class="small text-muted mt-1">
          {{ .summary | plainify | truncate 120 }}
        </div>
      </li>
      {{ end }}
    </ul>
    <div class="mt-3">
      <a href="{{ if eq .Page.Lang "ca" }}/blog/ca/{{ else }}/blog/{{ end }}" class="btn btn-sm btn-outline-primary">
        {{ cond (eq .Page.Lang "es") "Ver todos los artículos" (cond (eq .Page.Lang "ca") "Veure tots els articles" "View all articles") }} →
      </a>
    </div>
  </section>
  {{ end }}
{{ end }}
