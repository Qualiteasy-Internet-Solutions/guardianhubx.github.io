<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary: #007BFF;
        --text-dark: #1a202c;
        --text-light: #718096;
        --border: #e2e8f0;
        --bg-soft: #f8fafc;
    }
    #radar-form-container {
        font-family: 'Inter', -apple-system, sans-serif;
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid var(--border);
        overflow: hidden;
    }
    .form-slide { display: none; padding: 35px 25px; animation: fadeIn 0.4s ease; }
    .form-slide.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .pack-selection { display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
    @media (min-width: 480px) { .pack-selection { flex-direction: row; } }

    .pack-card {
        flex: 1; border: 2px solid var(--border); border-radius: 12px;
        padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .pack-card i { font-size: 28px; color: #cbd5e0; margin-bottom: 8px; display: block; }
    .pack-card span { font-weight: 700; color: var(--text-dark); font-size: 1rem; }
    .pack-card:hover, .pack-card.selected { border-color: var(--primary); background: #f0f7ff; }
    .pack-card.selected i { color: var(--primary); }

    .field-group { margin-bottom: 22px; }
    .field-label {
        display: flex; align-items: center; gap: 10px;
        font-weight: 700; font-size: 0.9rem; color: var(--text-dark);
        margin-bottom: 8px;
    }
    .field-label i { 
        color: var(--primary); background: var(--bg-soft); 
        width: 32px; height: 32px; display: flex; align-items: center; 
        justify-content: center; border-radius: 8px; font-size: 0.9rem;
    }
    .form-input {
        width: 100%; padding: 14px 16px; border: 1.5px solid var(--border);
        border-radius: 10px; font-size: 16px; box-sizing: border-box;
    }
    .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .help-text { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; display: block; }

    .btn-main {
        background: var(--primary); color: white; width: 100%; padding: 16px;
        border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 700;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        gap: 10px; margin-top: 15px; transition: 0.2s;
    }
    .btn-main:hover { background: #006ae0; }
    #progress-fill { height: 5px; background: var(--primary); width: 0%; transition: width 0.4s; }
</style>

<div id="radar-form-container">
    <div style="background: #edf2f7;"><div id="progress-fill"></div></div>
    <form id="radar-form" novalidate></form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('radar-form');
    const progressFill = document.getElementById('progress-fill');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjApoCRR9VuhMRjDQx4i_Xn3Q8vFYoQ3jeOEw98z_pBYgVYpouScUwEI6IVldpLR5h/exec'; 

    let step = 0;
    let data = { 
        pack: '', num_comanda: '', nif_compra: '',
        admin_nom: '', admin_dni: '', contacte_whatsapp: '',
        dominis: '', emails_radar: '' 
    };

    function render() {
        let html = "";
        switch(step) {
            case 0: // PAS 0: TRIAR PACK
    html = `
    <div class="form-slide active">
        <div style="text-align:center; margin-bottom:30px;">            
            <h2 style="margin-top:10px; font-size:1.5rem;">{{ i18n "radar_welcome_title" | safeJS }}</h2>
            <p style="color:var(--text-light);">{{ i18n "radar_subtitle" | safeJS }}</p>
        </div>
        <div class="pack-selection">
            <div class="pack-card" data-pack="autonom"><i class="fas fa-user-tie"></i><span>{{ i18n "radar_pack_autonom" | safeJS }}</span></div>
            <div class="pack-card" data-pack="pime"><i class="fas fa-building"></i><span>{{ i18n "radar_pack_pime" | safeJS }}</span></div>
        </div>
    </div>`;
    break;

            case 1:
                html = `
                <div class="form-slide active">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-link" style="color:var(--primary); margin-right:10px;"></i> {{ i18n "radar_link_order_title" | safeJS }}</h3>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-hashtag"></i> {{ i18n "radar_order_number_label" | safeJS }}</div>
                        <input type="text" id="val-comanda" class="form-input" placeholder="{{ i18n "radar_order_placeholder" | safeJS }}" value="${data.num_comanda}">
                        <span class="help-text">{{ i18n "radar_order_number_help" | safeJS }}</span>
                    </div>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-id-card"></i> {{ i18n "radar_nif_cif_label" | safeJS }}</div>
                        <input type="text" id="val-nif" class="form-input" placeholder="{{ i18n "radar_nif_placeholder" | safeJS }}" value="${data.nif_compra}">
                    </div>
                    <button type="button" onclick="window.goNext(2)" class="btn-main">{{ i18n "radar_btn_verify_continue" | safeJS }} <i class="fas fa-arrow-right"></i></button>
                </div>`;
                break;

            case 2:
                html = `
                <div class="form-slide active">
                    <h3 style="margin-bottom:25px;"><i class="fas fa-user-shield" style="color:var(--primary); margin-right:10px;"></i> {{ i18n "radar_identity_monitor_title" | safeJS }}</h3>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-user"></i> {{ i18n "radar_admin_name_label" | safeJS }}</div>
                        <input type="text" id="val-admin-nom" class="form-input" placeholder="{{ i18n "radar_admin_name_placeholder" | safeJS }}" value="${data.admin_nom}">
                    </div>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-fingerprint"></i> {{ i18n "radar_admin_dni_label" | safeJS }}</div>
                        <input type="text" id="val-admin-dni" class="form-input" placeholder="{{ i18n "radar_admin_dni_placeholder" | safeJS }}" value="${data.admin_dni}">
                        <span class="help-text">{{ i18n "radar_admin_dni_help" | safeJS }}</span>
                    </div>
                    <div class="field-group">
                        <div class="field-label"><i class="fab fa-whatsapp"></i> {{ i18n "radar_whatsapp_label" | safeJS }}</div>
                        <input type="tel" id="val-whatsapp" class="form-input" placeholder="{{ i18n "radar_whatsapp_placeholder" | safeJS }}" value="${data.contacte_whatsapp}">
                    </div>
                    <button type="button" onclick="window.goNext(3)" class="btn-main">{{ i18n "radar_btn_final_step" | safeJS }} <i class="fas fa-arrow-right"></i></button>
                </div>`;
                break;

            case 3:
                const max = data.pack === 'pime' ? 10 : 2;
                const emailLabel = `{{ i18n "radar_emails_label" | safeJS }}`.replace('%max%', max);
                
                html = `
                <div class="form-slide active">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-microchip" style="margin-right:10px; color:var(--primary);"></i> {{ i18n "radar_assets_title" | safeJS }}</h3>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-globe"></i> {{ i18n "radar_domains_label" | safeJS }}</div>
                        <textarea id="val-dominis" class="form-input" rows="2" placeholder="{{ i18n "radar_domains_placeholder" | safeJS }}">${data.dominis}</textarea>
                    </div>
                    <div class="field-group">
                        <div class="field-label"><i class="fas fa-at"></i> ${emailLabel}</div>
                        <div id="email-list">
                            <input type="email" class="form-input email-item" style="margin-bottom:10px" placeholder="${data.pack === 'autonom' ? '{{ i18n "radar_email_corp_placeholder" | safeJS }}' : '{{ i18n "radar_email_generic_placeholder" | safeJS }} 1'}">
                            ${data.pack === 'autonom' ? '<input type="email" class="form-input email-item" placeholder="{{ i18n "radar_email_personal_placeholder" | safeJS }}">' : ''}
                        </div>
                        ${data.pack === 'pime' ? '<button type="button" id="add-mail" style="background:#f8fafc; border:1.5px dashed var(--primary); color:var(--primary); width:100%; padding:10px; border-radius:8px; cursor:pointer; font-weight:600;">{{ i18n "radar_btn_add_email" | safeJS }}</button>' : ''}
                    </div>
                    <button type="button" id="final-btn" class="btn-main">{{ i18n "radar_btn_activate_radar" | safeJS }}</button>
                </div>`;
                break;

            case 4:
                const successMsg = `{{ i18n "radar_success_msg" | safeJS }}`.replace('%s%', data.num_comanda);
                html = `<div class="form-slide active" style="text-align:center; padding: 50px 10px;">
                    <i class="fas fa-check-circle" style="font-size:60px; color:#48bb78; margin-bottom:20px;"></i>
                    <h2>{{ i18n "radar_success_title" | safeJS }}</h2>
                    <p>${successMsg}</p>
                </div>`;
                break;
        }
        form.innerHTML = html;
        progressFill.style.width = (step / 4 * 100) + '%';
        bind();
    }

    function bind() {
        document.querySelectorAll('.pack-card').forEach(c => {
            c.onclick = () => { data.pack = c.dataset.pack; step = 1; render(); };
        });

        if (document.getElementById('add-mail')) {
            document.getElementById('add-mail').onclick = () => {
                const list = document.getElementById('email-list');
                if (list.querySelectorAll('input').length < 10) {
                    const inp = document.createElement('input');
                    inp.type = 'email'; inp.className = 'form-input email-item';
                    inp.style.margin = '10px 0 0'; 
                    inp.placeholder = '{{ i18n "radar_email_generic_placeholder" | safeJS }} ' + (list.querySelectorAll('input').length + 1);
                    list.appendChild(inp);
                }
            };
        }

        if (document.getElementById('final-btn')) {
    document.getElementById('final-btn').onclick = () => {
        // 1. Recollim les dades finals
        data.dominis = document.getElementById('val-dominis').value;
        data.emails_radar = Array.from(document.querySelectorAll('.email-item')).map(i => i.value).filter(v => v !== '').join(', ');

        // 2. Mostrem una pantalla de càrrega artificial
        form.innerHTML = `
            <div class="form-slide active" style="text-align:center; padding: 60px 20px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
                <h2 id="loading-text">{{ i18n "radar_saving_title" | safeJS }}</h2>
                <p>{{ i18n "radar_saving_subtitle" | safeJS }}</p>
            </div>`;

        // 3. Enviem les dades realment al Google Script
        const formData = new FormData();
        for (const key in data) { formData.append(key, data[key]); }
        
        const fetchPromise = fetch(SCRIPT_URL, { method: 'POST', body: formData });

        // 4. Forçem una espera de 2 segons perquè l'usuari vegi que "estem treballant"
        setTimeout(() => {
            fetchPromise.then(() => {
                step = 4; // Passem al missatge d'èxit
                render();
            }).catch(() => {
                // En cas d'error, també mostrem l'èxit per no bloquejar l'usuari (les dades solen arribar igual)
                step = 4;
                render();
            });
        }, 2000); 
    };
}
    }

    window.goNext = (s) => {
        if (s === 2) {
            data.num_comanda = document.getElementById('val-comanda').value;
            data.nif_compra = document.getElementById('val-nif').value;
            if (!data.num_comanda || !data.nif_compra) { alert("{{ i18n "radar_error_required" | safeJS }}"); return; }
        }
        if (s === 3) {
            data.admin_nom = document.getElementById('val-admin-nom').value;
            data.admin_dni = document.getElementById('val-admin-dni').value;
            data.contacte_whatsapp = document.getElementById('val-whatsapp').value;
            if(!data.admin_nom || !data.admin_dni) { alert("{{ i18n "radar_error_admin_data" | safeJS }}"); return; }
        }
        step = s; render();
    };

    render();
});
</script>