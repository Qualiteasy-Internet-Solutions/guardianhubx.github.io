{{/* /layouts/shortcodes/formulari-ciberseguretat.html */}}

{{/* IMPORTANT: Aquest shortcode està dissenyat per ser autocontingut.
    Inclou el seu propi estil (CSS) i lògica (JavaScript) per evitar conflictes
    amb la resta de la teva web.
*/}}

{{/* ================== CSS DEL FORMULARI ================== */}}
<style>
    :root {
        --form-primary-color: #007BFF;
        --form-background-color: #f0f2f5;
        --form-text-color: #333;
        --form-container-bg: #ffffff;
        --form-button-hover-bg: #0056b3;
    }
    #cyber-form-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--form-container-bg);
        color: var(--form-text-color);
        width: 100%;
        max-width: 700px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
        position: relative;
        margin: 40px auto; /* Centra el formulari a la pàgina */
    }
    .form-slide {
        display: none;
        padding: 40px 50px;
        animation: form-fadeIn 0.5s ease-in-out;
    }
    .form-slide.active { display: block; }
    @keyframes form-fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #cyber-form-container h2 {
        font-size: 24px;
        margin-top: 0;
        margin-bottom: 25px;
        font-weight: 600;
        color: var(--form-text-color);
    }
    .option-group { display: flex; flex-direction: column; gap: 12px; }
    .option-button, .checkbox-label {
        display: block; width: 100%; padding: 15px 20px;
        background-color: var(--form-background-color);
        border: 1px solid #ddd; border-radius: 6px; cursor: pointer;
        transition: all 0.2s ease; text-align: left; font-size: 16px;
    }
    .option-button:hover, .checkbox-label:hover {
        background-color: #e9ecef; border-color: var(--form-primary-color);
    }
    .option-button.selected {
        background-color: var(--form-primary-color); color: white; border-color: var(--form-primary-color);
    }
    .form-input {
        width: 100%; padding: 12px; border: 1px solid #ccc;
        border-radius: 5px; font-size: 16px; margin-top: 5px; margin-bottom: 15px;
        box-sizing: border-box;
    }
    #progress-bar-container { width: 100%; background-color: #e9ecef; }
    #progress-bar { width: 0%; height: 8px; background-color: var(--form-primary-color); transition: width 0.3s ease; }
    #submit-btn, #next-checkbox {
        background-color: var(--form-primary-color); color: white; padding: 15px 25px;
        border: none; border-radius: 5px; cursor: pointer; font-size: 18px;
        margin-top: 20px; transition: background-color 0.2s ease;
    }
    #submit-btn:hover, #next-checkbox:hover { background-color: var(--form-button-hover-bg); }
    #loader { text-align: center; padding: 50px; }
    #loader p { font-size: 20px; font-weight: 500; }
    #result-display { text-align: center; }
    #result-display h3 { color: var(--form-primary-color); font-size: 22px; }
    .spinner {
        border: 8px solid #f3f3f3; border-top: 8px solid var(--form-primary-color);
        border-radius: 50%; width: 60px; height: 60px;
        animation: form-spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes form-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

{{/* ================== HTML DEL FORMULARI ================== */}}
<div id="cyber-form-container">
    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>
    <form id="cyber-form" novalidate>
        </form>
</div>

{{/* ================== JAVASCRIPT DEL FORMULARI ================== */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Evita que el script s'executi múltiples vegades si s'inclou diverses vegades per error.
    if (window.cyberFormInitialized) return;
    window.cyberFormInitialized = true;

    const form = document.getElementById('cyber-form');
    const progressBar = document.getElementById('progress-bar');
    
    // URL del teu Web App de Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyQ16W0q3ItFn2cS9MhEJmxa-tBaWXtDfBvXLnTlb9nnlEN8WPycdC0U1WgU1YWeXVS-A/exec'
    const questions = [
        // Afegeix aquí totes les teves preguntes en format objecte.
        // He inclòs les primeres com a exemple. Completa la resta.
        { type: 'radio', colIndex: 2, title: '¿Cómo calificarías la probabilidad de que tu organización sufra un ciberataque en los próximos 12 meses?', options: ['Muy baja', 'Baja', 'Media', 'Alta', 'Muy alta'] },
        { type: 'radio', colIndex: 3, title: 'Si tu organización sufriera un ataque de ransomware, ¿cómo de grave crees que sería el impacto?', options: ['Insignificante', 'Leve', 'Moderado', 'Grave', 'Catastrófico'] },
        { type: 'radio', colIndex: 4, title: '¿Cuánto miedo tienes a que un ataque cibernético interrumpa por completo las operaciones de tu empresa?', options: ['Ninguno', 'Poco', 'Moderado', 'Alto', 'Extremadamente alto'] },
        { type: 'radio', colIndex: 5, title: '¿Tu empresa cuenta con un plan de respuesta ante incidentes cibernéticos?', options: ["Sí, y lo hemos probado recientemente", "Sí, pero no lo hemos probado", "No estamos seguros", "No, pero estamos trabajando en ello", "No tenemos ningún plan"] },
        { type: 'radio', colIndex: 6, title: '¿Cada cuánto tiempo se realizan simulacros o ejercicios de ciberseguridad en tu organización?', options: ["Cada tres meses o menos", "Cada seis meses", "Una vez al año", "Nunca"]},
        { type: 'radio', colIndex: 7, title: '¿Tu organización tiene copias de seguridad actualizadas y protegidas contra ransomware?', options: ["Sí, con copias redundantes y pruebas periódicas", "Sí, pero no las probamos regularmente", "No estamos seguros", "No"]},
        { type: 'radio', colIndex: 8, title: '¿Con qué frecuencia se capacita al personal en ciberseguridad?', options: ["Cada trimestre o más", "Dos veces al año", "Una vez al año", "Nunca"]},
        { type: 'radio', colIndex: 9, title: '¿Tu equipo directivo considera la ciberseguridad una prioridad estratégica?', options: ["Sí, está en la agenda de la alta dirección", "Sí, pero sin acciones concretas", "No lo tenemos claro", "No, la ciberseguridad no es una prioridad"]},
        { type: 'radio', colIndex: 10, title: '¿Los empleados son conscientes de los riesgos del phishing y cómo identificarlos?', options: ["Sí, todos", "Sí, pero solo algunos", "No estamos seguros", "No"]},
        { type: 'checkbox', colIndex: 11, title: '¿Qué medidas de seguridad tiene implementadas tu organización?', options: ["Antivirus y firewall actualizado", "Autenticación multifactor (MFA)", "Segmentación de red", "Monitorización de amenazas en tiempo real", "Evaluaciones de seguridad periódicas", "Ninguna de las anteriores"] },
        { type: 'radio', colIndex: 12, title: '¿Tu organización ha sufrido algún incidente de ciberseguridad en los últimos 12 meses?', options: ["No", "Sí, pero fue menor", "Sí, y causó interrupciones graves", "Sí, y aún estamos recuperándonos"]},
        { type: 'radio', colIndex: 13, title: '¿Tu empresa cuenta con un proveedor externo de seguridad informática?', options: ["Sí, y realizamos auditorías regulares", "Sí, pero no estamos seguros de su efectividad", "No, lo gestionamos internamente", "No tenemos ningún proveedor"]},
        { type: 'radio', colIndex: 14, title: '¿Tu organización cumple con normativas de ciberseguridad relevantes (GDPR, etc.)?', options: ["Sí, completamente", "Sí, en gran parte", "No estamos seguros", "No"]},
        { type: 'radio', colIndex: 15, title: '¿Cómo calificarías el nivel de cumplimiento con las mejores prácticas de ciberseguridad?', options: ["Excelente", "Bueno", "Regular", "Deficiente", "Inexistente"]},
        { type: 'radio', colIndex: 16, title: '¿Tu organización cuenta con ciberseguro?', options: ["Sí, con cobertura amplia y revisiones periódicas", "Sí, pero con cobertura limitada", "No estamos seguros", "No contamos con ciberseguro"]}
    ];

    const contactFields = `
        <div id="result-display">
            <h2>¡Casi listo!</h2>
            <p>Para recibir tu informe de ciberseguridad completo y personalizado, por favor, introduce tus datos.</p>
        </div>
        <h2>Tus datos de contacto</h2>
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" class="form-input" required>
        <label for="email">Dirección de correo electrónico</label>
        <input type="email" id="email" name="email" class="form-input" required>
        <label for="organizacion">Organización</label>
        <input type="text" id="organizacion" name="organizacion" class="form-input" required>
        <button type="submit" id="submit-btn">Generar y Enviar mi Informe</button>
    `;

    const loaderHTML = `
        <div id="loader">
            <p>Estamos generando tu informe personalizado con IA...</p>
            <div class="spinner"></div>
            <p>Recibirás el informe en tu correo electrónico en unos instantes. ¡Gracias!</p>
        </div>
    `;

    let currentQuestionIndex = 0;
    const answers = new Array(23).fill('');

    function renderQuestion() {
        if (currentQuestionIndex < questions.length) {
            const q = questions[currentQuestionIndex];
            let optionsHTML = '';
            if (q.type === 'radio') {
                optionsHTML = q.options.map(opt => `<button type="button" class="option-button" data-value="${opt}">${opt}</button>`).join('');
            } else if (q.type === 'checkbox') {
                optionsHTML = q.options.map(opt => `<label class="checkbox-label"><input type="checkbox" name="medidas" value="${opt}"> ${opt}</label>`).join('');
                optionsHTML += `<button type="button" id="next-checkbox">Siguiente</button>`;
            }
            form.innerHTML = `<div class="form-slide active"><h2>${q.title}</h2><div class="option-group">${optionsHTML}</div></div>`;
        } else {
            // Mostra els camps de contacte
            form.innerHTML = `<div class="form-slide active">${contactFields}</div>`;
        }
        updateProgressBar();
    }

    function updateProgressBar() {
        const progress = (currentQuestionIndex / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    form.addEventListener('click', function(e) {
        if (e.target.classList.contains('option-button')) {
            const q = questions[currentQuestionIndex];
            answers[q.colIndex] = e.target.dataset.value;
            currentQuestionIndex++;
            setTimeout(renderQuestion, 200);
        }
        if (e.target.id === 'next-checkbox') {
            const q = questions[currentQuestionIndex];
            const checkedValues = Array.from(form.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value).join(', ');
            answers[q.colIndex] = checkedValues || "Ninguna de las anteriores";
            currentQuestionIndex++;
            renderQuestion();
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Omplir dades finals
        answers[1] = document.getElementById('email').value;
        answers[17] = document.getElementById('nombre').value;
        answers[18] = document.getElementById('organizacion').value;
        answers[0] = new Date().toISOString(); // Marca temporal
        answers[19] = "He leído y acepto la política de privacidad"; // Checkbox legal

        form.innerHTML = `<div class="form-slide active">${loaderHTML}</div>`;

        const formData = new FormData();
        answers.forEach((value, index) => {
            formData.append(`col${index}`, value);
        });

        fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log('Success!', data);
                // Canvia el text del loader a un missatge d'èxit
                document.getElementById('loader').innerHTML = "<p>✅ ¡Informe enviado con éxito! Revisa tu bandeja de entrada.</p>";
            })
            .catch(error => {
                console.error('Error!', error.message);
                document.getElementById('loader').innerHTML = "<p>❌ Ha ocurrido un error. Por favor, inténtalo de nuevo más tarde.</p>";
            });
    });

    renderQuestion();
});
</script>