{{/* /layouts/shortcodes/formulari-ciberseguretat.html */}}

<style>
    :root {
        --form-primary-color: #007BFF;
        --form-background-color: #f0f2f5;
        --form-text-color: #333;
        --form-container-bg: #ffffff;
        --form-button-hover-bg: #0056b3;
    }
    #cyber-form-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--form-container-bg);
        color: var(--form-text-color);
        width: 100%;
        max-width: 700px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
        position: relative;
        margin: 40px auto;
    }
    .form-slide {
        display: none;
        padding: 40px 50px;
        animation: form-fadeIn 0.5s ease-in-out;
    }
    .form-slide.active { display: block; }
    @keyframes form-fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #cyber-form-container h2 {
        font-size: 24px;
        margin-top: 0;
        margin-bottom: 25px;
        font-weight: 600;
        color: var(--form-text-color);
    }
    .option-group { display: flex; flex-direction: column; gap: 12px; }
    .option-button, .checkbox-label {
        display: block; width: 100%; padding: 15px 20px;
        background-color: var(--form-background-color);
        border: 1px solid #ddd; border-radius: 6px; cursor: pointer;
        transition: all 0.2s ease; text-align: left; font-size: 16px;
    }
    .option-button:hover, .checkbox-label:hover {
        background-color: #e9ecef; border-color: var(--form-primary-color);
    }
    .option-button.selected {
        background-color: var(--form-primary-color); color: white; border-color: var(--form-primary-color);
    }
    #cyber-form-container .form-input {
        width: 100%; padding: 12px; border: 1px solid #ccc;
        border-radius: 5px; font-size: 16px; margin-top: 5px; margin-bottom: 15px;
        box-sizing: border-box;
    }
    #progress-bar-container { width: 100%; background-color: #e9ecef; }
    #progress-bar { width: 0%; height: 8px; background-color: var(--form-primary-color); transition: width 0.3s ease; }
    #cyber-form-container .btn {
        display: inline-block;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 5px;
        transition: all 0.2s ease-in-out;
        border: 1px solid transparent;
        text-decoration: none;
    }
    #cyber-form-container .btn-primary {
        color: #fff;
        background-color: var(--form-primary-color);
    }
    #cyber-form-container .btn-primary:hover {
        background-color: var(--form-button-hover-bg);
    }
    #loader { text-align: center; padding: 50px; }
    .spinner {
        border: 8px solid #f3f3f3; border-top: 8px solid var(--form-primary-color);
        border-radius: 50%; width: 60px; height: 60px;
        animation: form-spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes form-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div id="cyber-form-container">
    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>
    <form id="cyber-form" novalidate></form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (window.cyberFormInitialized) return;
    window.cyberFormInitialized = true;

    const form = document.getElementById('cyber-form');
    const progressBar = document.getElementById('progress-bar');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxNSMoUe72OstdspSYzzRRoI9PGnNepmR9CdaHuMDq604hgI_FxfqqAWK5iHkRStJH68Q/exec';

    const questionsData = {
        gateway: {
            id: 'role',
            title: `{{ i18n "q0_role" | safeJS }}`,
            options: [
                { text: `{{ i18n "q0_opt_1" | safeJS }}`, path: 'pathA' },
                { text: `{{ i18n "q0_opt_2" | safeJS }}`, path: 'pathB' },
                { text: `{{ i18n "q0_opt_3" | safeJS }}`, path: 'pathC' }
            ]
        },
        pathA: [
            { title: `{{ i18n "qa_1_impact" | safeJS }}`, options: [`{{ i18n "qa_1_opt_1" | safeJS }}`, `{{ i18n "qa_1_opt_2" | safeJS }}`, `{{ i18n "qa_1_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qa_2_human" | safeJS }}`, options: [`{{ i18n "qa_2_opt_1" | safeJS }}`, `{{ i18n "qa_2_opt_2" | safeJS }}`, `{{ i18n "qa_2_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qa_3_response" | safeJS }}`, options: [`{{ i18n "qa_3_opt_1" | safeJS }}`, `{{ i18n "qa_3_opt_2" | safeJS }}`, `{{ i18n "qa_3_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qa_4_insurance" | safeJS }}`, options: [`{{ i18n "qa_4_opt_1" | safeJS }}`, `{{ i18n "qa_4_opt_2" | safeJS }}`, `{{ i18n "qa_4_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qa_5_budget" | safeJS }}`, options: [`{{ i18n "qa_5_opt_1" | safeJS }}`, `{{ i18n "qa_5_opt_2" | safeJS }}`, `{{ i18n "qa_5_opt_3" | safeJS }}`] }
        ],
        pathB: [
            { title: `{{ i18n "qb_1_mfa" | safeJS }}`, options: [`{{ i18n "qb_1_opt_1" | safeJS }}`, `{{ i18n "qb_1_opt_2" | safeJS }}`, `{{ i18n "qb_1_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qb_2_backup" | safeJS }}`, options: [`{{ i18n "qb_2_opt_1" | safeJS }}`, `{{ i18n "qb_2_opt_2" | safeJS }}`, `{{ i18n "qb_2_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qb_3_endpoint" | safeJS }}`, options: [`{{ i18n "qb_3_opt_1" | safeJS }}`, `{{ i18n "qb_3_opt_2" | safeJS }}`, `{{ i18n "qb_3_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qb_4_phishing_sim" | safeJS }}`, options: [`{{ i18n "qb_4_opt_1" | safeJS }}`, `{{ i18n "qb_4_opt_2" | safeJS }}`, `{{ i18n "qb_4_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qb_5_vuln" | safeJS }}`, options: [`{{ i18n "qb_5_opt_1" | safeJS }}`, `{{ i18n "qb_5_opt_2" | safeJS }}`, `{{ i18n "qb_5_opt_3" | safeJS }}`] }
        ],
        pathC: [
            { title: `{{ i18n "qc_1_passwords" | safeJS }}`, options: [`{{ i18n "qc_1_opt_1" | safeJS }}`, `{{ i18n "qc_1_opt_2" | safeJS }}`, `{{ i18n "qc_1_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qc_2_phishing" | safeJS }}`, options: [`{{ i18n "qc_2_opt_1" | safeJS }}`, `{{ i18n "qc_2_opt_2" | safeJS }}`, `{{ i18n "qc_2_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qc_3_wifi" | safeJS }}`, options: [`{{ i18n "qc_3_opt_1" | safeJS }}`, `{{ i18n "qc_3_opt_2" | safeJS }}`, `{{ i18n "qc_3_opt_3" | safeJS }}`] },
            { title: `{{ i18n "qc_4_updates" | safeJS }}`, options: [`{{ i18n "qc_4_opt_1" | safeJS }}`, `{{ i18n "qc_4_opt_2" | safeJS }}`, `{{ i18n "qc_4_opt_3" | safeJS }}`] }
        ]
    };

    let currentPath = null; 
    let currentIndex = 0;
    let userRole = '';
    const answers = new Array(25).fill('');
    let storedReportHTML = ''; 

    function renderQuestion() {
        form.innerHTML = '';
        let q = null;
        let optionsHTML = '';

        if (!currentPath) {
            q = questionsData.gateway;
            optionsHTML = q.options.map((opt) => 
                `<button type="button" class="option-button gateway-btn" data-path="${opt.path}" data-role="${opt.text}">${opt.text}</button>`
            ).join('');
            updateProgressBar(0, 1); 
        } else {
            const pathQuestions = questionsData[currentPath];
            if (currentIndex < pathQuestions.length) {
                q = pathQuestions[currentIndex];
                optionsHTML = q.options.map(opt => 
                    `<button type="button" class="option-button answer-btn" data-value="${opt}">${opt}</button>`
                ).join('');
                updateProgressBar(currentIndex, pathQuestions.length);
            } else {
                showGenerationScreen();
                return;
            }
        }
        form.innerHTML = `<div class="form-slide active"><h2>${q.title}</h2><div class="option-group">${optionsHTML}</div></div>`;
    }

    function updateProgressBar() {
        // Total de passos: 1 (Gateway) + 5 (Preguntes del cam√≠)
        const totalSteps = 6; 
        let currentStep = 0;

        if (!currentPath) {
            // Estem a la primera pantalla (Gateway)
            currentStep = 0.5; // Comencem amb una mica de barra
        } else {
            // Ja hem passat el Gateway (1) + l'√≠ndex actual de la pregunta
            currentStep = 1 + currentIndex;
        }

        const progress = (currentStep / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;
    }

    form.addEventListener('click', function(e) {
        if (e.target.classList.contains('gateway-btn')) {
            currentPath = e.target.dataset.path;
            userRole = e.target.dataset.role;
            currentIndex = 0;
            answers[2] = userRole; 
            setTimeout(renderQuestion, 200);
        }
        if (e.target.classList.contains('answer-btn')) {
            const val = e.target.dataset.value;
            const qTitle = questionsData[currentPath][currentIndex].title;
            answers[3 + currentIndex] = `${qTitle}: ${val}`;
            currentIndex++;
            setTimeout(renderQuestion, 200);
        }
    });

    function showGenerationScreen() {
        form.innerHTML = `
            <div class="form-slide active text-center" style="text-align:center;">
                <h2 class="title">{{ i18n "form_ready_title" | safeJS }}</h2>
                <p class="lead">{{ i18n "form_analyzed_msg" | safeJS }}</p>
                <button type="button" id="generar-informe-btn" class="btn btn-primary">{{ i18n "btn_generate_report" | safeJS }}</button>
            </div>`;
        document.getElementById('generar-informe-btn').addEventListener('click', procesarYGenerar);
    }

    function procesarYGenerar() {
        form.innerHTML = `<div class="form-slide active"><div id="loader"><p>{{ i18n "form_generating_report_title" | safeJS }}</p><div class="spinner"></div><p>Analizando vulnerabilidades cr√≠ticas...</p></div></div>`;
        answers[0] = new Date().toISOString();
        const formData = new FormData();
        answers.forEach((value, index) => { formData.append(`col${index}`, value); });

        fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => response.json()) // ‚úÖ Ara llegim JSON
            .then(data => {
                // Guardem les dades reals que venen de l'Excel/IA
                storedReportHTML = data.html;
                const realScore = data.score;
                mostrarTeaserYCaptura(realScore); // ‚úÖ Passem la nota real
            })
            .catch(error => {
                console.error('Error:', error);
                form.innerHTML = `<p>‚ùå Ha habido un error de conexi√≥n.</p>`;
            });
    }

    function mostrarTeaserYCaptura(score) {
        form.innerHTML = '';
        
        // Convertim a n√∫mero per seguretat
        let finalScore = parseInt(score) || 0;

        // L√≤gica de colors segons la nota real de l'Excel
        let color = "#dc3545"; // Vermell (0-39)
        let label = "RIESGO CR√çTICO";
        let desc = "Tu nivel de protecci√≥n es muy bajo. Necesitas actuar urgentemente.";

        if (finalScore >= 40 && finalScore < 70) {
            color = "#ffc107"; // Groc (40-69)
            label = "RIESGO MODERADO";
            desc = "Tienes medidas b√°sicas, pero existen brechas de seguridad.";
        } else if (finalScore >= 70) {
            color = "#28a745"; // Verd (70-100)
            label = "NIVEL SEGURO";
            desc = "Tu organizaci√≥n sigue buenas pr√°cticas de seguridad.";
        }

        const strokeDash = (finalScore * 251.2) / 100;

        form.innerHTML = `
            <div class="form-slide active" style="text-align:center; padding: 10px 0;">
                
                <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 20px;">
                    <svg width="150" height="150" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" stroke="#eeeeee" stroke-width="8" fill="transparent" />
                        <circle cx="50" cy="50" r="40" stroke="${color}" stroke-width="8" fill="transparent" 
                                stroke-dasharray="${strokeDash} 251.2" stroke-linecap="round" transform="rotate(-90 50 50)" />
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <span style="font-size: 32px; font-weight: 800; color: #333;">${finalScore}</span>
                        <span style="font-size: 14px; color: #999;">/100</span>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <div style="display: inline-block; padding: 6px 20px; background: ${color}; color: white; border-radius: 50px; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
                        ${label}
                    </div>
                    <p style="color: #666; font-size: 15px; max-width: 400px; margin: 0 auto;">${desc}</p>
                </div>
                
                <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom: 30px; text-align:left; border: 1px solid #eee;">
                    <p style="font-weight: bold; color: var(--form-primary-color); margin-bottom: 12px; font-size: 16px;">üîì Tu auditor√≠a personalizada incluye:</p>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 14px; color: #444;">
                        <li style="margin-bottom: 8px; display: flex; align-items: start;"><span style="color: #28a745; margin-right: 10px;">‚úî</span> <span><strong>An√°lisis de Vulnerabilidades:</strong> Los 3 puntos cr√≠ticos detectados.</span></li>
                        <li style="margin-bottom: 8px; display: flex; align-items: start;"><span style="color: #28a745; margin-right: 10px;">‚úî</span> <span><strong>Hoja de Ruta:</strong> C√≥mo mejorar tu nota hoy mismo.</span></li>
                    </ul>
                </div>

                <div id="email-gate-container" style="max-width: 450px; margin: 0 auto; text-align: left;">
                    <p style="font-weight: bold; margin-bottom: 15px; text-align: center;">Completa los datos para recibir el informe:</p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <input type="text" id="nombre-gate" placeholder="Tu nombre" class="form-input" style="margin:0;">
                        <input type="email" id="email-gate" placeholder="Tu email profesional" class="form-input" style="margin:0;">
                        <input type="text" id="org-gate" placeholder="Tu organizaci√≥n" class="form-input" style="margin:0;">
                        <button type="button" id="unlock-report-btn" class="btn btn-primary" style="width:100%; height: 50px; font-size: 17px; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,123,255,0.2);">
                            üì© Desbloquear Auditor√≠a Completa
                        </button>
                    </div>
                </div>
            </div>`;

        document.getElementById('unlock-report-btn').addEventListener('click', function() {
            const name = document.getElementById('nombre-gate').value;
            const email = document.getElementById('email-gate').value;
            const org = document.getElementById('org-gate').value || "Individual";
            if (!email.includes('@') || name.length < 2) { alert("Por favor, introduce datos v√°lidos."); return; }
            enviarEmailFinal(name, email, org);
        });
    }

    function enviarEmailFinal(name, email, org) {
        const container = document.getElementById('email-gate-container');
        container.innerHTML = `<div class="spinner"></div><p style="text-align:center;">Enviando informe a ${email}...</p>`;

        const emailData = new FormData();
        emailData.append('action', 'send_email');
        emailData.append('email', email);
        emailData.append('nombre', name);
        emailData.append('organizacion', org);
        emailData.append('html', storedReportHTML); 

        fetch(SCRIPT_URL, { method: 'POST', body: emailData })
            .then(() => {
                form.innerHTML = `
                    <div class="form-slide active" style="text-align:center; padding: 30px 10px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üöÄ</div>
                        <h2 style="font-size: 26px; color: #28a745; margin-bottom: 10px;">¬°Auditor√≠a enviada!</h2>
                        <p style="font-size: 16px; color: #555; margin-bottom: 30px;">Revisa tu correo <strong>${email}</strong>.</p>
                        
                        <div style="background: #f0f7ff; padding: 25px; border-radius: 15px; border: 1px solid #cfe2ff; max-width: 450px; margin: 0 auto;">
                            <h3 style="font-size: 18px; margin-bottom: 20px; color: #0056b3; font-weight: bold;">¬øQu√© quieres hacer ahora?</h3>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <a href="https://guardianhubx.com/es/guardianradar/" class="btn btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; text-decoration: none; font-weight: bold;">
                                    üõ°Ô∏è Protegerme con GuardianRadar
                                </a>
                                <a href="https://wa.me/34934153115" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; background: #25D366; color: white; border-radius: 5px; text-decoration: none; font-weight: bold;">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="20" height="20" alt="WhatsApp"> Consultar por WhatsApp
                                </a>
                                <a href="https://guardianhubx.com/es/index.html#contact" style="color: #666; text-decoration: underline; font-size: 13px; margin-top: 5px;">
                                    O usa el formulario de contacto tradicional
                                </a>
                            </div>
                        </div>
                    </div>`;
            })
            .catch(err => {
                container.innerHTML = `<p style="color:red;">Error al enviar. Int√©ntalo de nuevo.</p>`;
            });
    }

    renderQuestion();
});
</script>