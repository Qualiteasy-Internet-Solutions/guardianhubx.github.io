{{/* /layouts/shortcodes/formulari-ciberseguretat.html */}}

<style>
    :root {
        --form-primary-color: #007BFF;
        --form-background-color: #f0f2f5;
        --form-text-color: #333;
        --form-container-bg: #ffffff;
        --form-button-hover-bg: #0056b3;
    }
    #cyber-form-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--form-container-bg);
        color: var(--form-text-color);
        width: 100%;
        max-width: 700px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
        position: relative;
        margin: 40px auto; /* Centra el formulari a la pàgina */
    }
    .form-slide {
        display: none;
        padding: 40px 50px;
        animation: form-fadeIn 0.5s ease-in-out;
    }
    .form-slide.active { display: block; }
    @keyframes form-fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #cyber-form-container h2 {
        font-size: 24px;
        margin-top: 0;
        margin-bottom: 25px;
        font-weight: 600;
        color: var(--form-text-color);
    }
    .option-group { display: flex; flex-direction: column; gap: 12px; }
    .option-button, .checkbox-label {
        display: block; width: 100%; padding: 15px 20px;
        background-color: var(--form-background-color);
        border: 1px solid #ddd; border-radius: 6px; cursor: pointer;
        transition: all 0.2s ease; text-align: left; font-size: 16px;
    }
    .option-button:hover, .checkbox-label:hover {
        background-color: #e9ecef; border-color: var(--form-primary-color);
    }
    .option-button.selected {
        background-color: var(--form-primary-color); color: white; border-color: var(--form-primary-color);
    }
    #cyber-form-container.form-input {
        width: 100%; padding: 12px; border: 1px solid #ccc;
        border-radius: 5px; font-size: 16px; margin-top: 5px; margin-bottom: 15px;
        box-sizing: border-box;
    }
    #progress-bar-container { width: 100%; background-color: #e9ecef; }
    #progress-bar { width: 0%; height: 8px; background-color: var(--form-primary-color); transition: width 0.3s ease; }
    #cyber-form-container #submit-btn, #cyber-form-container #next-checkbox  {
        background-color: var(--form-primary-color); color: white; padding: 15px 25px;
        border: none; border-radius: 5px; cursor: pointer; font-size: 18px;
        margin-top: 20px; transition: background-color 0.2s ease;
    }
    #cyber-form-container .btn {
    display: inline-block;
    font-family: inherit; /* Hereda la font del formulari */
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 5px;
    transition: all 0.2s ease-in-out;
    }

    /* Estil específic per al botó primari (blau) */
    #cyber-form-container .btn-primary {
    color: #fff;
    background-color: var(--form-primary-color);
    border-color: var(--form-primary-color);
    }

    /* Efecte hover per al botó primari */
    #cyber-form-container .btn-primary:hover {
    background-color: var(--form-button-hover-bg);
    border-color: var(--form-button-hover-bg);
    }
    #cyber-form-container #submit-btn:hover, #cyber-form-container #next-checkbox:hover { background-color: var(--form-button-hover-bg); }
    #loader { text-align: center; padding: 50px; }
    #loader p { font-size: 20px; font-weight: 500; }
    #result-display { text-align: center; }
    #result-display h3 { color: var(--form-primary-color); font-size: 22px; }
    .spinner {
        border: 8px solid #f3f3f3; border-top: 8px solid var(--form-primary-color);
        border-radius: 50%; width: 60px; height: 60px;
        animation: form-spin 1s linear infinite; margin: 20px auto;
    }
    .spinner-inline {
        display: inline-block;
        width: 16px;
        height: 16px;
        vertical-align: text-bottom;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: form-spin 0.75s linear infinite;
        margin-right: 8px;
    }
    @keyframes form-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div id="cyber-form-container">
    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>
    <form id="cyber-form" novalidate>
        </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (window.cyberFormInitialized) return;
    window.cyberFormInitialized = true;

    // Aquesta funció d'ajuda només substitueix placeholders, com {email}
    const T = (key, placeholders) => {
        let str = key;
        if (placeholders) {
            for (const p in placeholders) {
                str = str.replace(`{${p}}`, placeholders[p]);
            }
        }
        return str;
    };
    
    const form = document.getElementById('cyber-form');
    const progressBar = document.getElementById('progress-bar');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwaliNtuGyG6obfaHE4d9CTmmCq2dkYdCwE7g2QZmI1fyuyKDuG4dwG1ofS0nljNxTnyw/exec';

    // Construïm l'array de preguntes directament amb les traduccions de Hugo.
    // Usem `safeJS` per assegurar que les cometes o altres caràcters no trenquin el codi.
    const questions = [
        { type: 'radio', colIndex: 2, title: `{{ i18n "q1_title" | safeJS }}`, options: [`{{ i18n "q1_opt_1" | safeJS }}`, `{{ i18n "q1_opt_2" | safeJS }}`, `{{ i18n "q1_opt_3" | safeJS }}`, `{{ i18n "q1_opt_4" | safeJS }}`, `{{ i18n "q1_opt_5" | safeJS }}`] },
        { type: 'radio', colIndex: 3, title: `{{ i18n "q2_title" | safeJS }}`, options: [`{{ i18n "q2_opt_1" | safeJS }}`, `{{ i18n "q2_opt_2" | safeJS }}`, `{{ i18n "q2_opt_3" | safeJS }}`, `{{ i18n "q2_opt_4" | safeJS }}`, `{{ i18n "q2_opt_5" | safeJS }}`] },
        { type: 'radio', colIndex: 4, title: `{{ i18n "q3_title" | safeJS }}`, options: [`{{ i18n "q3_opt_1" | safeJS }}`, `{{ i18n "q3_opt_2" | safeJS }}`, `{{ i18n "q3_opt_3" | safeJS }}`, `{{ i18n "q3_opt_4" | safeJS }}`, `{{ i18n "q3_opt_5" | safeJS }}`] },
        { type: 'radio', colIndex: 5, title: `{{ i18n "q4_title" | safeJS }}`, options: [`{{ i18n "q4_opt_1" | safeJS }}`, `{{ i18n "q4_opt_2" | safeJS }}`, `{{ i18n "q4_opt_3" | safeJS }}`, `{{ i18n "q4_opt_4" | safeJS }}`, `{{ i18n "q4_opt_5" | safeJS }}`] },
        { type: 'radio', colIndex: 6, title: `{{ i18n "q5_title" | safeJS }}`, options: [`{{ i18n "q5_opt_1" | safeJS }}`, `{{ i18n "q5_opt_2" | safeJS }}`, `{{ i18n "q5_opt_3" | safeJS }}`, `{{ i18n "q5_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 7, title: `{{ i18n "q6_title" | safeJS }}`, options: [`{{ i18n "q6_opt_1" | safeJS }}`, `{{ i18n "q6_opt_2" | safeJS }}`, `{{ i18n "q6_opt_3" | safeJS }}`, `{{ i18n "q6_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 8, title: `{{ i18n "q7_title" | safeJS }}`, options: [`{{ i18n "q7_opt_1" | safeJS }}`, `{{ i18n "q7_opt_2" | safeJS }}`, `{{ i18n "q7_opt_3" | safeJS }}`, `{{ i18n "q7_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 9, title: `{{ i18n "q8_title" | safeJS }}`, options: [`{{ i18n "q8_opt_1" | safeJS }}`, `{{ i18n "q8_opt_2" | safeJS }}`, `{{ i18n "q8_opt_3" | safeJS }}`, `{{ i18n "q8_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 10, title: `{{ i18n "q9_title" | safeJS }}`, options: [`{{ i18n "q9_opt_1" | safeJS }}`, `{{ i18n "q9_opt_2" | safeJS }}`, `{{ i18n "q9_opt_3" | safeJS }}`, `{{ i18n "q9_opt_4" | safeJS }}`] },
        { type: 'checkbox', colIndex: 11, title: `{{ i18n "q10_title" | safeJS }}`, options: [`{{ i18n "q10_opt_1" | safeJS }}`, `{{ i18n "q10_opt_2" | safeJS }}`, `{{ i18n "q10_opt_3" | safeJS }}`, `{{ i18n "q10_opt_4" | safeJS }}`, `{{ i18n "q10_opt_5" | safeJS }}`, `{{ i18n "q10_opt_6" | safeJS }}`] },
        { type: 'radio', colIndex: 12, title: `{{ i18n "q11_title" | safeJS }}`, options: [`{{ i18n "q11_opt_1" | safeJS }}`, `{{ i18n "q11_opt_2" | safeJS }}`, `{{ i18n "q11_opt_3" | safeJS }}`, `{{ i18n "q11_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 13, title: `{{ i18n "q12_title" | safeJS }}`, options: [`{{ i18n "q12_opt_1" | safeJS }}`, `{{ i18n "q12_opt_2" | safeJS }}`, `{{ i18n "q12_opt_3" | safeJS }}`, `{{ i18n "q12_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 14, title: `{{ i18n "q13_title" | safeJS }}`, options: [`{{ i18n "q13_opt_1" | safeJS }}`, `{{ i18n "q13_opt_2" | safeJS }}`, `{{ i18n "q13_opt_3" | safeJS }}`, `{{ i18n "q13_opt_4" | safeJS }}`] },
        { type: 'radio', colIndex: 15, title: `{{ i18n "q14_title" | safeJS }}`, options: [`{{ i18n "q14_opt_1" | safeJS }}`, `{{ i18n "q14_opt_2" | safeJS }}`, `{{ i18n "q14_opt_3" | safeJS }}`, `{{ i18n "q14_opt_4" | safeJS }}`, `{{ i18n "q14_opt_5" | safeJS }}`] },
        { type: 'radio', colIndex: 16, title: `{{ i18n "q15_title" | safeJS }}`, options: [`{{ i18n "q15_opt_1" | safeJS }}`, `{{ i18n "q15_opt_2" | safeJS }}`, `{{ i18n "q15_opt_3" | safeJS }}`, `{{ i18n "q15_opt_4" | safeJS }}`] }
    ];
    
    let currentQuestionIndex = 0;
    const answers = new Array(23).fill('');
    let informeHtmlFinal = '';

    function renderQuestion() {
        if (currentQuestionIndex < questions.length) {
            const q = questions[currentQuestionIndex];
            let optionsHTML = '';
            if (q.type === 'radio') {
                optionsHTML = q.options.map(opt => `<button type="button" class="option-button" data-value="${opt}">${opt}</button>`).join('');
            } else if (q.type === 'checkbox') {
                optionsHTML = q.options.map(opt => `<label class="checkbox-label"><input type="checkbox" name="medidas" value="${opt}"> ${opt}</label>`).join('');
                optionsHTML += `<button type="button" id="next-checkbox" class="btn btn-primary">{{ i18n "btn_next" | safeJS }}</button>`;
            }
            form.innerHTML = `<div class="form-slide active"><h2>${q.title}</h2><div class="option-group">${optionsHTML}</div></div>`;
        } else {
            form.innerHTML = `
                <div class="form-slide active text-center">
                    <h2 class="title">{{ i18n "form_ready_title" | safeJS }}</h2>
                    <p class="lead">{{ i18n "form_ready_subtitle" | safeJS }}</p>
                    <button id="generar-informe-btn" class="btn btn-primary">{{ i18n "btn_generate_report" | safeJS }}</button>
                </div>`;
            document.getElementById('generar-informe-btn').addEventListener('click', enviarFormulario);
        }
        updateProgressBar();
    }

    function updateProgressBar() {
        const progress = (currentQuestionIndex / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    form.addEventListener('click', function(e) {
        if (e.target.classList.contains('option-button')) {
            const q = questions[currentQuestionIndex];
            answers[q.colIndex] = e.target.dataset.value;
            currentQuestionIndex++;
            setTimeout(renderQuestion, 200);
        }
        if (e.target.id === 'next-checkbox') {
            const q = questions[currentQuestionIndex];
            const checkedValues = Array.from(form.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value).join(', ');
            answers[q.colIndex] = checkedValues || q.options[q.options.length - 1];
            currentQuestionIndex++;
            renderQuestion();
        }
    });

    function sendReportByEmail(name, email, organization, wrapperElement) {
        const emailBtn = wrapperElement.querySelector('button');
        if (emailBtn) {
            emailBtn.disabled = true;
            emailBtn.innerHTML = `<span class="spinner-inline"></span> {{ i18n "form_sending_email" | safeJS }}`;
        }

        const emailData = new FormData();
        emailData.append('action', 'send_email');
        emailData.append('email', email);
        emailData.append('nombre', name);
        emailData.append('organizacion', organization);
        emailData.append('html', informeHtmlFinal);

        fetch(SCRIPT_URL, { method: 'POST', body: emailData })
            .then(res => {
                if (!res.ok) throw new Error(`{{ i18n "server_error" | safeJS }}`);
                return res.text();
            })
            .then(msg => {
                let successMsg = `{{ i18n "form_email_success" | safeJS }}`;

                if (window.initialUserData) {
                    wrapperElement.innerHTML = `
                    <div style="text-align:center;">
                        <p style="font-weight:bold;">✅ ${successMsg.replace('{email}', email)}</p>
                        <br>
                        <button type="button" id="play-again-btn" class="btn btn-primary mt-3">Jugar a Space Invaders 🚀</button>
                    </div>
                    `;
                    document.getElementById('play-again-btn').addEventListener('click', () => {
                    window.location.href = '/spaceinvaders/'; 
                    });
                } else {
                    wrapperElement.innerHTML = `<p style="text-align:center; font-weight:bold;">✅ ${successMsg.replace('{email}', email)}</p>`;
                }
            })
            .catch(err => {
                let errorMsg = `{{ i18n "form_email_error" | safeJS }}`;
                wrapperElement.innerHTML += `<p class="error-message" style="color:red; text-align:center;">❌ ${errorMsg.replace('{error}', err.message)}</p>`;
                if (emailBtn) {
                    emailBtn.disabled = false;
                    emailBtn.innerHTML = `{{ i18n "btn_submit_email" | safeJS }}`;
                }
                console.error('Error al enviar:', err);
            });
    }
    
    function enviarFormulario() {
        form.innerHTML = `<div class="form-slide active"><div id="loader"><p>{{ i18n "form_generating_report_title" | safeJS }}</p><div class="spinner"></div><p>{{ i18n "form_generating_report_subtitle" | safeJS }}</p></div></div>`;
        answers[0] = new Date().toISOString();
        answers[1] = answers[1] || "no-reply@guardianhubx.com";
        answers[17] = answers[17] || "Responsable de Ciberseguridad";
        answers[18] = answers[18] || "Organización Anónima";

        const formData = new FormData();
        answers.forEach((value, index) => {
            formData.append(`col${index}`, value);
        });

        fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) throw new Error(`{{ i18n "server_error" | safeJS }}`);
                return response.text();
            })
            .then(html => {
                informeHtmlFinal = marked.parse(html);
                if (window.initialUserData && window.initialUserData.email) {
                    // CAS 1: Tenim les dades, enviem automàticament
                    form.innerHTML = `
                      <div class="form-slide active">
                        <h2 class="title">{{ i18n "form_report_generated_title" | safeJS }}</h2>
                        <div class="informe-container" style="text-align: left;">${informeHtmlFinal}</div>
                        <div id="auto-send-status" style="margin-top: 30px;">
                          <p>{{ i18n "form_sending_auto" | safeJS }} <strong>${window.initialUserData.email}</strong>...</p>
                          <div class="spinner"></div>
                        </div>
                      </div>`;
                      sendReportByEmail(
                        window.initialUserData.name,
                        window.initialUserData.email,
                        "Participant del joc",
                        document.getElementById('auto-send-status')
                    );

                } else {
                    form.innerHTML = `
                    <div class="form-slide active">
                        <h2 class="title">{{ i18n "form_report_generated_title" | safeJS }}</h2>
                        <div class="informe-container" style="text-align: left;">
                        ${informeHtmlFinal}
                        </div>
                        <p class="mt-4">{{ i18n "form_ask_for_email" | safeJS }}</p>
                        <button type="button" id="enviar-por-email" class="btn btn-primary mt-2">{{ i18n "btn_send_by_email" | safeJS }}</button>
                        <div id="formulario-contacto-wrapper" style="display: none; margin-top: 30px;"></div>
                    </div>`;

                document.getElementById('enviar-por-email').addEventListener('click', () => {
                    document.getElementById('formulario-contacto-wrapper').innerHTML = `
                        <h2>{{ i18n "form_contact_details_title" | safeJS }}</h2>
                        <label for="nombre">{{ i18n "form_label_fullname" | safeJS }}</label>
                        <input type="text" id="nombre" name="nombre" class="form-input" required>
                        <label for="email">{{ i18n "form_label_email" | safeJS }}</label>
                        <input type="email" id="email" name="email" class="form-input" required>
                        <label for="organizacion">{{ i18n "form_label_organization" | safeJS }}</label>
                        <input type="text" id="organizacion" name="organizacion" class="form-input" required>
                        <button id="submit-email-btn" class="btn btn-primary mt-3">{{ i18n "btn_submit_email" | safeJS }}</button>`;
                    document.getElementById('formulario-contacto-wrapper').style.display = 'block';

                    document.getElementById('submit-email-btn').addEventListener('click', (event) => {
                        event.preventDefault(); 
                        const name = document.getElementById('nombre').value;
                        const email = document.getElementById('email').value;
                        const org = document.getElementById('organizacion').value;
                        const wrapper = document.getElementById('formulario-contacto-wrapper');


                        if (!name.trim() || !email.trim() || !org.trim()) {
                            alert(`{{ i18n "form_validation_error" | safeJS }}`);
                            return; 
                        }   
                        
                        sendReportByEmail(name, email, org, wrapper);

                        });
                    });
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                form.innerHTML = `<p>❌ {{ i18n "form_fetch_error" | safeJS }}</p>`;
            });
    }
    renderQuestion();
});
</script>