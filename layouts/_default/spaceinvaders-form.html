<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Â¡Felicidades por tu puntuaciÃ³n!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link id="arcade-css" rel="stylesheet" href="/css/arcade.css">
  <link id="main-css" rel="stylesheet" href="{{ "css/style.css" | relURL }}" disabled>
  <link id="phishing-css" rel="stylesheet" href="/css/landing_phishing.css" disabled>
</head>
<body>
<div class="box-arcade" id="arcade-container">
  <div class="arcade-bg-img"></div>
  <div class="arcade-header">
    <span class="pixel-star">â˜…</span>
    Â¡Felicidades por tu puntuaciÃ³n en <span style="color:#ffd900;">Space Invaders!</span>
    <span class="pixel-star">â˜…</span>
    <div style="font-size:2em;letter-spacing:0.12em;text-align:center;margin-bottom:12px;">
      ğŸ‘¾ğŸ‘¾ğŸ‘¾ğŸš€ğŸ‘¾ğŸ‘¾ğŸ‘¾
    </div>
  </div>
  <div class="arcade-score-img">
    <div class="score-title">PuntuaciÃ³n:</div>
    <div class="score-points" id="score-value"></div>
  </div>
  <form id="score-form">
    <input type="text" id="score-name" name="name" placeholder="Nombre" required><br>
    <input type="email" id="score-email" name="email" placeholder="Email" required><br>
    <input type="hidden" id="score-hidden" name="score">
    <button type="submit">Guardar puntuaciÃ³n</button>
    <div id="score-status"></div>
  </form>
</div>

<!-- Leaderboard -->
<div id="leaderboard-wrap" class="leaderboard" style="display:none;">
  <h3>ğŸ† Top 5</h3>
  <table class="lb-table" id="lb-table">
    <thead>
      <tr><th>#</th><th>Jugador</th><th style="text-align:right;">Puntos</th></tr>
    </thead>
    <tbody id="lb-body"></tbody>
  </table>
  <div class="lb-meta">
    <div id="lb-rank">Tu posiciÃ³n: â€“</div>
    <div id="lb-total">Participantes: â€“</div>
  </div>
  <div class="btn-container">
  <a href="#" id="btn-continue" class="btn-next">Continuar al test de ciberseguridad âœ</a>
</div>
</div>

<div id="next-test" style="display:none;">
  <!-- AquÃ­ se inserta el test de ciberseguridad -->
  {{ .Content }}
</div>

<script type="module">

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('mode') === 'event') {
  window.isEventMode = true; // Creem la "bandera" global
  console.log("Mode esdeveniment detectat. Variable global 'isEventMode' establerta.");
}

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://uqqgrlxkzplgwonjweun.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxcWdybHhrenBsZ3dvbmp3ZXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzA1NDcsImV4cCI6MjA3NDk0NjU0N30.EzK0A81ghdnKgYkx9_qLDEcr8ROKpFd-4UM9K924d0M"
);

//Security

const SECRET_KEY = "ElMeuEventSpaceInvadersSuperSecret777!";
function simpleHash(str, seed = 0) {
  let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
  for(let i = 0, ch; i < str.length; i++) {
    ch = str.charCodeAt(i);
    h1 = Math.imul(h1 ^ ch, 2654435761);
    h2 = Math.imul(h2 ^ ch, 1597334677);
  }
  h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
  h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
  h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
  h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
  return 4294967296 * (2097151 & h2) + (h1 >>> 0);
};

const score = urlParams.get('score') || '';
const receivedHash = urlParams.get('verify') || '';
const gameId = urlParams.get('gid') || '';
const expectedHash = simpleHash(score + gameId + SECRET_KEY).toString();
const isScoreValid = expectedHash === receivedHash && gameId !== '';


if (!isScoreValid && score !== '') {
  console.error("ALERTA DE SEGURETAT: El hash de la puntuaciÃ³ no coincideix. Trampa detectada.");
  document.getElementById('score-value').innerText = "???";
  document.getElementById('score-hidden').value = "0";
  const form = document.getElementById('score-form');
  if (form) {
    form.innerHTML = `<p style="color:red; text-align:center; font-size:1.2em;">La puntuaciÃ³n recibida no es valida.</p>`;
  }
} else if (score) {
  if(score) console.log("PuntuaciÃ³ verificada correctament.");
  document.getElementById('score-value').innerText = score;
  document.getElementById('score-hidden').value = score;
}

function renderLeaderboard(top, yourId, totals, yourRank) {
  const tbody = document.getElementById('lb-body');
  if (!tbody) return;

  tbody.innerHTML = '';
  top.forEach((row, idx) => {
    const tr = document.createElement('tr');
    if (row.id === yourId) tr.classList.add('you');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${row.user ?? 'â€”'}</td>
      <td style="text-align:right;">${row.score}</td>
    `;
    tbody.appendChild(tr);
  });

  const rankEl = document.getElementById('lb-rank');
  const totEl  = document.getElementById('lb-total');
  if (rankEl) rankEl.textContent = `Tu posiciÃ³n: #${yourRank ?? 'â€”'}`;
  if (totEl)  totEl.textContent  = `Participantes: ${totals ?? 'â€”'}`;

  const wrap = document.getElementById('leaderboard-wrap');
  if (wrap) wrap.style.display = 'block';

  const btn = document.getElementById('btn-continue');
  if (btn) {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('leaderboard-wrap').style.display = 'none';
      document.getElementById('arcade-container').style.display = 'none';
      document.getElementById('next-test').style.display = 'block';

      let arcade = document.getElementById('arcade-css');
      if (arcade) arcade.disabled = true;
      let main = document.getElementById('main-css');
      if (main) main.disabled = false;
      let phishing = document.getElementById('phishing-css');
      if (phishing) phishing.disabled = false;
    }, { once: true });
  }
}

async function loadLeaderboardAfterSave(yourId, score) {
  // 1) Top 5
  const { data: top, error: topErr } = await supabase
    .from('scores')
    .select('id,user,email,score')
    .order('score', { ascending: false })
    .limit(5);
  if (topErr) { console.error(topErr); return; }

  // 2) Total participants (sense descarregar files)
  const { count: totalCount, error: totalErr } = await supabase
    .from('scores')
    .select('id', { count: 'exact', head: true });
  if (totalErr) console.error(totalErr);

  // 3) Rank = (# de puntuacions > la teva) + 1
  const { count: betterCount, error: rankErr } = await supabase
    .from('scores')
    .select('id', { count: 'exact', head: true })
    .gt('score', Number(score));
  if (rankErr) console.error(rankErr);

  const yourRank = (betterCount ?? 0) + 1;

  // Render
  renderLeaderboard(top || [], yourId, totalCount ?? 'â€”', yourRank);
}

// Guarda i mostra rÃ nquing
document.getElementById('score-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!document.getElementById('score-name')) {
    console.warn("S'ha intentat enviar un formulari de puntuaciÃ³ invÃ lida.");
    return;
  }
  const name  = document.getElementById('score-name').value.trim();
  const email = document.getElementById('score-email').value.trim();
  const score = document.getElementById('score-hidden').value;

  if (!name || !email || !score) {
    document.getElementById('score-status').innerText = "Introduce tu nombre y correo.";
    return;
  }

  window.initialUserData = { name, email };
  document.getElementById('score-status').innerText = "Guardando tu puntuaciÃ³n...";

  // Inserim UNA sola vegada i recuperem l'ID
  const { data: inserted, error } = await supabase
    .from('scores')
    .insert([{ user: name, email, score: parseInt(score, 10), game_id: gameId }])
    .select('id')
    .single();

  if (error) {
    console.error(error);  
    if (error.code === '23505') {
      document.getElementById('score-status').innerText = "Error: Esta puntuaciÃ³n ya ha estado registrada.";
    } else {
      document.getElementById('score-status').innerText = "Error al guardar el score.";
    }
    return;
  }

  document.getElementById('score-status').innerText = "Â¡PuntuaciÃ³n guardada correctamente!";
  setTimeout(async () => {
    document.getElementById('score-form').style.display = "none";
    await loadLeaderboardAfterSave(inserted.id, score);
  }, 800);
});
</script>

</body>
</html>