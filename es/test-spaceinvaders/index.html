<!doctype html><html lang=es><head><meta charset=utf-8><title>¬°Felicidades por tu puntuaci√≥n!</title>
<meta name=viewport content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel=stylesheet><link id=arcade-css rel=stylesheet href=/css/arcade.css><link id=main-css rel=stylesheet href=/css/style.css disabled><link id=phishing-css rel=stylesheet href=/css/landing_phishing.css disabled></head><body><div class=box-arcade id=arcade-container><div class=arcade-bg-img></div><div class=arcade-header><span class=pixel-star>‚òÖ</span>
¬°Felicidades por tu puntuaci√≥n en <span style=color:#ffd900>Space Invaders!</span>
<span class=pixel-star>‚òÖ</span><div style=font-size:2em;letter-spacing:.12em;text-align:center;margin-bottom:12px>üëæüëæüëæüöÄüëæüëæüëæ</div></div><div class=arcade-score-img><div class=score-title>Puntuaci√≥n:</div><div class=score-points id=score-value></div></div><form id=score-form><input type=text id=score-name name=name placeholder=Nombre required><br><input type=email id=score-email name=email placeholder=Email required><br><input type=hidden id=score-hidden name=score>
<button type=submit>Guardar puntuaci√≥n</button><div id=score-status></div></form></div><div id=leaderboard-wrap class=leaderboard style=display:none><h3>üèÜ Top 5</h3><table class=lb-table id=lb-table><thead><tr><th>#</th><th>Jugador</th><th style=text-align:right>Puntos</th></tr></thead><tbody id=lb-body></tbody></table><div class=lb-meta><div id=lb-rank>Tu posici√≥n: ‚Äì</div><div id=lb-total>Participantes: ‚Äì</div></div><div class=btn-container><a href=# id=btn-continue class=btn-next>Continuar al test de ciberseguridad ‚ûú</a></div></div><div id=next-test style=display:none><section class=section><div class=container><style>:root{--form-primary-color:#007BFF;--form-background-color:#f0f2f5;--form-text-color:#333;--form-container-bg:#ffffff;--form-button-hover-bg:#0056b3}#cyber-form-container{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,Helvetica,Arial,sans-serif;background-color:var(--form-container-bg);color:var(--form-text-color);width:100%;max-width:700px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:hidden;position:relative;margin:40px auto}.form-slide{display:none;padding:40px 50px;animation:form-fadeIn .5s ease-in-out}.form-slide.active{display:block}@keyframes form-fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}#cyber-form-container h2{font-size:24px;margin-top:0;margin-bottom:25px;font-weight:600;color:var(--form-text-color)}.option-group{display:flex;flex-direction:column;gap:12px}.option-button,.checkbox-label{display:block;width:100%;padding:15px 20px;background-color:var(--form-background-color);border:1px solid #ddd;border-radius:6px;cursor:pointer;transition:all .2s ease;text-align:left;font-size:16px}.option-button:hover,.checkbox-label:hover{background-color:#e9ecef;border-color:var(--form-primary-color)}.option-button.selected{background-color:var(--form-primary-color);color:#fff;border-color:var(--form-primary-color)}#cyber-form-container .form-input{width:100%;padding:12px;border:1px solid #ccc;border-radius:5px;font-size:16px;margin-top:5px;margin-bottom:15px;box-sizing:border-box}#progress-bar-container{width:100%;background-color:#e9ecef;height:8px}#progress-bar{width:0%;height:100%;background-color:var(--form-primary-color);transition:width .3s ease}#cyber-form-container .btn{display:inline-block;font-weight:600;text-align:center;cursor:pointer;padding:12px 20px;font-size:16px;border-radius:5px;transition:all .2s ease-in-out;border:1px solid transparent;text-decoration:none}#cyber-form-container .btn-primary{color:#fff;background-color:var(--form-primary-color)}#cyber-form-container .btn-primary:hover{background-color:var(--form-button-hover-bg)}#loader{text-align:center;padding:50px}.spinner{border:8px solid #f3f3f3;border-top:8px solid var(--form-primary-color);border-radius:50%;width:60px;height:60px;animation:form-spin 1s linear infinite;margin:20px auto}@keyframes form-spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><div id=cyber-form-container><div id=progress-bar-container><div id=progress-bar></div></div><form id=cyber-form novalidate></form></div><script>document.addEventListener("DOMContentLoaded",function(){if(window.cyberFormInitialized)return;window.cyberFormInitialized=!0;const e={risk_critical:`RIESGO CR√çTICO`,risk_moderate:`RIESGO MODERADO`,risk_safe:`NIVEL SEGURO`,desc_critical:`Tu nivel de protecci√≥n es muy bajo.`,desc_moderate:`Tienes medidas b√°sicas, pero existen brechas.`,desc_safe:`Tu organizaci√≥n sigue buenas pr√°cticas.`,desc_fallback:`Hemos detectado vulnerabilidades graves en tu infraestructura.`,audit_includes:`üîì Tu auditor√≠a personalizada incluye:`,audit_analysis:`An√°lisis Detallado`,audit_analysis_desc:`Explicaci√≥n t√©cnica de tus riesgos.`,audit_roadmap:`Plan de Acci√≥n`,audit_roadmap_desc:`Pasos concretos para protegerte hoy.`,form_complete_data:`Completa los datos para recibir el informe:`,placeholder_name:`Tu nombre`,placeholder_email:`Tu email profesional`,placeholder_org:`Tu organizaci√≥n`,btn_unlock:`üì© Desbloquear Auditor√≠a Completa`,alert_invalid:`Por favor, introduce datos v√°lidos.`,loading_generating:`Generando informe detallado...<br><small>(Esto puede tardar unos 60 segundos)</small>`,success_sent:`¬°Auditor√≠a enviada!`,success_check_email:`Revisa tu correo`,next_steps:`¬øQu√© quieres hacer ahora?`,btn_protect:`üõ°Ô∏è Protegerme con GuardianRadar`,btn_whatsapp:`Consultar por WhatsApp`,link_contact:`O usa el formulario de contacto tradicional`,error_sending:`Error al enviar. Int√©ntalo de nuevo.`},u="es",t=document.getElementById("cyber-form"),d=document.getElementById("progress-bar"),l="https://script.google.com/macros/s/AKfycbx9oHFYzUigU3UuHKeZyWqz5tGN70gd3ADIDvf2PYVO-Ya0uZFz9Iow4TgFpb30ycuEmA/exec",r={gateway:{id:"role",title:`Para adaptar el informe a tu realidad, ¬øcu√°l es tu rol principal?`,options:[{text:`Direcci√≥n / Gerencia / Propietario`,path:"pathA"},{text:`Responsable IT / T√©cnico / CISO`,path:"pathB"},{text:`Empleado / Usuario Individual`,path:"pathC"}]},pathA:[{title:`Si debido a un ciberataque todos los sistemas se bloquearan hoy y no pudierais trabajar durante 3 d√≠as, ¬øcu√°l ser√≠a el impacto?`,options:[`Catastr√≥fico: P√©rdidas econ√≥micas graves y da√±o reputacional inmediato.`,`Grave: Ser√≠a un caos, pero podr√≠amos operar manualmente con dificultades.`,`M√≠nimo: Tenemos sistemas de respaldo y continuidad garantizados.`]},{title:`¬øCrees que tus empleados sabr√≠an distinguir un correo de phishing sofisticado de uno real?`,options:[`No, seguramente alguien caer√≠a en la trampa.`,`Hemos hecho alguna formaci√≥n puntual, pero no estoy seguro al 100%.`,`S√≠, realizamos formaci√≥n continua y pruebas mensuales.`]},{title:`Si sufr√≠s un ataque ahora mismo, ¬øten√©is un protocolo de actuaci√≥n claro (a qui√©n llamar, qu√© desconectar)?`,options:[`No, improvisar√≠amos o llamar√≠amos al inform√°tico de urgencia.`,`Tenemos algo escrito, pero nunca hemos hecho un simulacro.`,`S√≠, tenemos un Plan de Respuesta a Incidentes probado anualmente.`]},{title:`¬øVuestra p√≥liza de seguros cubre espec√≠ficamente incidentes de ciberseguridad (rescates, multas, paralizaci√≥n)?`,options:[`No tenemos ciberseguro o no lo s√©.`,`S√≠, pero creo que la cobertura es b√°sica o limitada.`,`S√≠, tenemos una p√≥liza espec√≠fica y revisada regularmente.`]},{title:`¬øC√≥mo definir√≠as la inversi√≥n en ciberseguridad en tu empresa?`,options:[`Reactiva: Solo invertimos cuando algo se rompe.`,`B√°sica: Tenemos presupuesto para antivirus y licencias est√°ndar.`,`Estrat√©gica: Es una prioridad con presupuesto dedicado y recurrente.`]}],pathB:[{title:`¬øCu√°l es el nivel de implementaci√≥n del Doble Factor de Autenticaci√≥n (MFA/2FA)?`,options:[`Inexistente o solo para algunos administradores.`,`Parcial: Solo en el correo (Microsoft 365 / Google).`,`Total: En correo, VPN, acceso a servidores y aplicaciones cr√≠ticas.`]},{title:`¬øC√≥mo gestion√°is las copias de seguridad frente al Ransomware?`,options:[`Copias locales o en red (USB/NAS) accesibles desde los equipos.`,`Copia en la nube, pero sin garant√≠a de inmutabilidad.`,`Copias inmutables (Object Lock / Air-gapped) y regla 3-2-1.`]},{title:`¬øQu√© tecnolog√≠a utiliz√°is para proteger los endpoints (puestos de trabajo)?`,options:[`Antivirus tradicional basado en firmas.`,`Antivirus de nueva generaci√≥n (NGAV).`,`EDR / XDR con monitorizaci√≥n activa o servicio SOC.`]},{title:`¬øRealiz√°is campa√±as activas de simulaci√≥n de Phishing?`,options:[`No, nunca.`,`Puntualmente (una vez al a√±o).`,`S√≠, de forma recurrente y automatizada.`]},{title:`¬øCada cu√°nto realiz√°is escaneos de vulnerabilidades o gesti√≥n de parches?`,options:[`Manual o cuando el sistema operativo lo fuerza.`,`Gesti√≥n de parches automatizada, pero sin escaneos de vulnerabilidades.`,`Escaneos recurrentes y pol√≠tica de parcheo estricta.`]}],pathC:[{title:`Sinceramente, ¬øutilizas la misma contrase√±a (o variaciones muy similares) para el correo personal, redes y el trabajo?`,options:[`S√≠, es imposible recordarlas todas si no.`,`En algunos servicios poco importantes s√≠, pero intento variarlas.`,`No, utilizo un gestor de contrase√±as y todas son √∫nicas.`]},{title:`Cuando recibes un correo urgente del banco o paqueter√≠a con un enlace, ¬øqu√© haces?`,options:[`Si parece importante, hago clic para ver qu√© pasa.`,`Reviso el remitente, pero si el logo parece real, conf√≠o.`,`Nunca hago clic. Entro manualmente a la web oficial o app.`]},{title:`Cuando te conectas a una Wi-Fi p√∫blica (hotel, aeropuerto, cafeter√≠a)...`,options:[`Me conecto y navego normalmente.`,`Me conecto pero evito entrar en el banco.`,`Siempre activo la VPN o uso los datos de mi m√≥vil (4G/5G).`]},{title:`Cuando tu dispositivo te avisa de una actualizaci√≥n de seguridad pendiente...`,options:[`Lo pospongo indefinidamente ('Recordar m√°s tarde').`,`Lo hago al cabo de unos d√≠as o semanas.`,`Actualizo inmediatamente.`]}]};let s=null,n=0,c="",a=0;const o=new Array(25).fill("");function i(){t.innerHTML="";let e=null,o="";if(s){const t=r[s];if(n<t.length)e=t[n],o=e.options.map((e,t)=>{const n=t*10;return`<button type="button" class="option-button answer-btn" data-value="${e}" data-points="${n}">${e}</button>`}).join(""),h();else{f();return}}else e=r.gateway,o=e.options.map(e=>`<button type="button" class="option-button gateway-btn" data-path="${e.path}" data-role="${e.text}">${e.text}</button>`).join(""),h();t.innerHTML=`<div class="form-slide active"><h2>${e.title}</h2><div class="option-group">${o}</div></div>`}function h(){const t=6;let e=0;s?e=1+n:e=.5;const o=e/t*100;d.style.width=`${o}%`}t.addEventListener("click",function(e){if(e.target.classList.contains("gateway-btn")&&(s=e.target.dataset.path,c=e.target.dataset.role,n=0,o[2]=c,setTimeout(i,200)),e.target.classList.contains("answer-btn")){const t=e.target.dataset.value,c=parseInt(e.target.dataset.points)||0;a+=c;const l=r[s][n].title;o[3+n]=`${l}: ${t}`,n++,setTimeout(i,200)}});function f(){d.style.width="100%",t.innerHTML=`
                <div class="form-slide active text-center" style="text-align:center;">
                    <h2 class="title">‚úÖ Listo</h2>
                    <p class="lead">Hemos analizado tu perfil de seguridad.</p>
                    <button type="button" id="generar-informe-btn" class="btn btn-primary">Generar Informe</button>
                </div>`,document.getElementById("generar-informe-btn").addEventListener("click",p)}function p(){t.innerHTML=`<div class="form-slide active"><div id="loader"><p>Estamos generando tu informe personalizado con IA...</p><div class="spinner"></div><p>${e.loading_generating}</p></div></div>`,o[0]=(new Date).toISOString();const n=new FormData;o.forEach((e,t)=>{n.append(`col${t}`,e)}),n.append("calculatedScore",a),n.append("lang",u),fetch(l,{method:"POST",body:n}).then(e=>e.json()).then(e=>{m(e.score,e.summary)}).catch(e=>{console.error("Error:",e),m(a,null)})}function m(n,s){document.getElementById("progress-bar-container").style.display="none",t.innerHTML="";let o=parseInt(n)||0,i="#dc3545",r=e.risk_critical,a=e.desc_fallback;o>=40&&o<70?(i="#ffc107",r=e.risk_moderate):o>=70&&(i="#28a745",r=e.risk_safe),s&&s.length>5?a=s:o<40?a=e.desc_critical:o<70?a=e.desc_moderate:a=e.desc_safe;const c=o*251.2/100;t.innerHTML=`
                <div class="form-slide active" style="text-align:center; padding: 10px 0;">
                    
                    <div style="position: relative; width: 150px; height: 150px; margin: 0 auto 20px;">
                        <svg width="150" height="150" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#eeeeee" stroke-width="8" fill="transparent" />
                            <circle cx="50" cy="50" r="40" stroke="${i}" stroke-width="8" fill="transparent" 
                                    stroke-dasharray="${c} 251.2" stroke-linecap="round" transform="rotate(-90 50 50)" 
                                    style="transition: stroke-dasharray 1s ease-out;" />
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <span style="font-size: 32px; font-weight: 800; color: #333;">${o}</span>
                            <span style="font-size: 14px; color: #999;">/100</span>
                        </div>
                    </div>
    
                    <div style="margin-bottom: 25px;">
                        <div style="display: inline-block; padding: 6px 20px; background: ${i}; color: white; border-radius: 50px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                            ${r}
                        </div>
                        
                        <div style="background-color: #fff3cd; border-left: 5px solid ${i}; padding: 15px; text-align: left; border-radius: 4px; color: #555; font-size: 15px; max-width: 500px; margin: 0 auto; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            ${a}
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom: 30px; text-align:left; border: 1px solid #eee;">
                        <p style="font-weight: bold; color: var(--form-primary-color); margin-bottom: 12px; font-size: 16px;">${e.audit_includes}</p>
                        <ul style="list-style: none; padding: 0; margin: 0; font-size: 14px; color: #444;">
                            <li style="margin-bottom: 8px; display: flex; align-items: start;"><span style="color: #28a745; margin-right: 10px;">‚úî</span> <span><strong>${e.audit_analysis}</strong> ${e.audit_analysis_desc}</span></li>
                            <li style="margin-bottom: 8px; display: flex; align-items: start;"><span style="color: #28a745; margin-right: 10px;">‚úî</span> <span><strong>${e.audit_roadmap}</strong> ${e.audit_roadmap_desc}</span></li>
                        </ul>
                    </div>
    
                    <div id="email-gate-container" style="max-width: 450px; margin: 0 auto; text-align: left;">
                        <p style="font-weight: bold; margin-bottom: 15px; text-align: center;">${e.form_complete_data}</p>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input type="text" id="nombre-gate" placeholder="${e.placeholder_name}" class="form-input" style="margin:0;">
                            <input type="email" id="email-gate" placeholder="${e.placeholder_email}" class="form-input" style="margin:0;">
                            <input type="text" id="org-gate" placeholder="${e.placeholder_org}" class="form-input" style="margin:0;">
                            <button type="button" id="unlock-report-btn" class="btn btn-primary" style="width:100%; height: 50px; font-size: 17px; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,123,255,0.2);">
                                ${e.btn_unlock}
                            </button>
                        </div>
                    </div>
                </div>`,document.getElementById("unlock-report-btn").addEventListener("click",function(){const t=document.getElementById("nombre-gate").value,n=document.getElementById("email-gate").value,s=document.getElementById("org-gate").value||"Individual";if(!n.includes("@")||t.length<2){alert(e.alert_invalid);return}g(t,n,s)})}function g(n,s,o){const a=document.getElementById("email-gate-container");a.innerHTML=`<div class="spinner"></div><p style="text-align:center;">${e.loading_generating}</p>`;const i=new FormData;i.append("action","send_email"),i.append("email",s),i.append("nombre",n),i.append("organizacion",o),i.append("lang",u),fetch(l,{method:"POST",body:i}).then(()=>{t.innerHTML=`
                        <div class="form-slide active" style="text-align:center; padding: 30px 10px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">üöÄ</div>
                            <h2 style="font-size: 26px; color: #28a745; margin-bottom: 10px;">${e.success_sent}</h2>
                            <p style="font-size: 16px; color: #555; margin-bottom: 30px;">${e.success_check_email} <strong>${s}</strong>.</p>
                            
                            <div style="background: #f0f7ff; padding: 25px; border-radius: 15px; border: 1px solid #cfe2ff; max-width: 450px; margin: 0 auto;">
                                <h3 style="font-size: 18px; margin-bottom: 20px; color: #0056b3; font-weight: bold;">${e.next_steps}</h3>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <a href="https://guardianhubx.com/es/guardianradar/" class="btn btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; text-decoration: none; font-weight: bold;">
                                        ${e.btn_protect}
                                    </a>
                                    <a href="https://wa.me/34934153115" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; background: #25D366; color: white; border-radius: 5px; text-decoration: none; font-weight: bold;">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="20" height="20" alt="WhatsApp"> ${e.btn_whatsapp}
                                    </a>
                                    <a href="https://guardianhubx.com/es/index.html#contact" style="color: #666; text-decoration: underline; font-size: 13px; margin-top: 5px;">
                                        ${e.link_contact}
                                    </a>
                                </div>
                            </div>
                        </div>`}).catch(t=>{a.innerHTML=`<p style="color:red;">${e.error_sending}</p>`})}i()})</script></div></section></div><script type=module>

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('mode') === 'event') {
  window.isEventMode = true; 
  console.log("Mode esdeveniment detectat. Variable global 'isEventMode' establerta.");
}

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://uqqgrlxkzplgwonjweun.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxcWdybHhrenBsZ3dvbmp3ZXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzA1NDcsImV4cCI6MjA3NDk0NjU0N30.EzK0A81ghdnKgYkx9_qLDEcr8ROKpFd-4UM9K924d0M"
);



const SECRET_KEY = "ElMeuEventSpaceInvadersSuperSecret777!";
function simpleHash(str, seed = 0) {
  let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
  for(let i = 0, ch; i < str.length; i++) {
    ch = str.charCodeAt(i);
    h1 = Math.imul(h1 ^ ch, 2654435761);
    h2 = Math.imul(h2 ^ ch, 1597334677);
  }
  h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
  h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
  h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
  h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
  return 4294967296 * (2097151 & h2) + (h1 >>> 0);
};

const score = urlParams.get('score') || '';
const receivedHash = urlParams.get('verify') || '';
const gameId = urlParams.get('gid') || '';
const expectedHash = simpleHash(score + gameId + SECRET_KEY).toString();
const isScoreValid = expectedHash === receivedHash && gameId !== '';


if (!isScoreValid && score !== '') {
  console.error("ALERTA DE SEGURETAT: El hash de la puntuaci√≥ no coincideix. Trampa detectada.");
  document.getElementById('score-value').innerText = "???";
  document.getElementById('score-hidden').value = "0";
  const form = document.getElementById('score-form');
  if (form) {
    form.innerHTML = `<p style="color:red; text-align:center; font-size:1.2em;">La puntuaci√≥n recibida no es valida.</p>`;
  }
} else if (score) {
  if(score) console.log("Puntuaci√≥ verificada correctament.");
  document.getElementById('score-value').innerText = score;
  document.getElementById('score-hidden').value = score;
}

function renderLeaderboard(top, yourId, totals, yourRank) {
  const tbody = document.getElementById('lb-body');
  if (!tbody) return;

  tbody.innerHTML = '';
  top.forEach((row, idx) => {
    const tr = document.createElement('tr');
    if (row.id === yourId) tr.classList.add('you');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${row.user ?? '‚Äî'}</td>
      <td style="text-align:right;">${row.score}</td>
    `;
    tbody.appendChild(tr);
  });

  const rankEl = document.getElementById('lb-rank');
  const totEl  = document.getElementById('lb-total');
  if (rankEl) rankEl.textContent = `Tu posici√≥n: #${yourRank ?? '‚Äî'}`;
  if (totEl)  totEl.textContent  = `Participantes: ${totals ?? '‚Äî'}`;

  const wrap = document.getElementById('leaderboard-wrap');
  if (wrap) wrap.style.display = 'block';

  const btn = document.getElementById('btn-continue');
  if (btn) {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('leaderboard-wrap').style.display = 'none';
      document.getElementById('arcade-container').style.display = 'none';
      document.getElementById('next-test').style.display = 'block';

      let arcade = document.getElementById('arcade-css');
      if (arcade) arcade.disabled = true;
      let main = document.getElementById('main-css');
      if (main) main.disabled = false;
      let phishing = document.getElementById('phishing-css');
      if (phishing) phishing.disabled = false;
    }, { once: true });
  }
}

async function loadLeaderboardAfterSave(yourId, score) {
  
  const { data: top, error: topErr } = await supabase
    .from('scores')
    .select('id,user,email,score')
    .order('score', { ascending: false })
    .limit(5);
  if (topErr) { console.error(topErr); return; }

  
  const { count: totalCount, error: totalErr } = await supabase
    .from('scores')
    .select('id', { count: 'exact', head: true });
  if (totalErr) console.error(totalErr);

  
  const { count: betterCount, error: rankErr } = await supabase
    .from('scores')
    .select('id', { count: 'exact', head: true })
    .gt('score', Number(score));
  if (rankErr) console.error(rankErr);

  const yourRank = (betterCount ?? 0) + 1;

  
  renderLeaderboard(top || [], yourId, totalCount ?? '‚Äî', yourRank);
}


document.getElementById('score-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!document.getElementById('score-name')) {
    console.warn("S'ha intentat enviar un formulari de puntuaci√≥ inv√†lida.");
    return;
  }
  const name  = document.getElementById('score-name').value.trim();
  const email = document.getElementById('score-email').value.trim();
  const score = document.getElementById('score-hidden').value;

  if (!name || !email || !score) {
    document.getElementById('score-status').innerText = "Introduce tu nombre y correo.";
    return;
  }

  window.initialUserData = { name, email };
  document.getElementById('score-status').innerText = "Guardando tu puntuaci√≥n...";

  
  const { data: inserted, error } = await supabase
    .from('scores')
    .insert([{ user: name, email, score: parseInt(score, 10), game_id: gameId }])
    .select('id')
    .single();

  if (error) {
    console.error(error);  
    if (error.code === '23505') {
      document.getElementById('score-status').innerText = "Error: Esta puntuaci√≥n ya ha estado registrada.";
    } else {
      document.getElementById('score-status').innerText = "Error al guardar el score.";
    }
    return;
  }

  document.getElementById('score-status').innerText = "¬°Puntuaci√≥n guardada correctamente!";
  setTimeout(async () => {
    document.getElementById('score-form').style.display = "none";
    await loadLeaderboardAfterSave(inserted.id, score);
  }, 800);
});
</script></body></html>