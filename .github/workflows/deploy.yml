# .github/workflows/deploy.yml
name: Deploy site + blog

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout de la web principal
    - name: Checkout main site
      uses: actions/checkout@v3
      with:
        submodules: false

    # 2) Checkout del blog Hugo
    - name: Checkout blog repo
      uses: actions/checkout@v3
      with:
        repository: Qualiteasy-Internet-Solutions/guardianhubx-blog
        path: blog-src
        ref: main

    # 3) Instalar Hugo (solo para el blog)
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.146.0'
        extended: true

    # 4) Preparar public/ copiando TODO lo de la web principal
    - name: Prepare public directory
      run: |
        rm -rf public
        mkdir public
        # Copia todo excepto .git y la carpeta de workflow
        rsync -av \
          --exclude='.git' \
          --exclude='.github' \
          ./ public/
        # Evita Jekyll en GH Pages
        touch public/.nojekyll

    # 5) Build del blog Hugo en public/blog
    - name: Build blog
      run: |
        cd blog-src
        hugo --gc --minify --destination ../public/blog

    # 6) Deploy a GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: public
        user_name: "github-actions[bot]"
        user_email: "github-actions[bot]@users.noreply.github.com"